workflows:
    ios-workflow:
      name: iOS Workflow
      environment:
        vars:
          XCODE_WORKSPACE: "Perp.xcodeproj" # <-- Put the name of your workspace here.
          XCODE_SCHEME: "Perp" # <-- Put the name of your scheme here.
          BUNDLE_ID: "com.beauth.perpetual" # <-- Put your Bundle Id here.
          # https://docs.codemagic.io/code-signing-yaml/signing-ios/
          APP_STORE_CONNECT_ISSUER_ID: Encrypted(Z0FBQUFBQmhMNGR6SDgzVWtKSENJV1VNMC1jV3pzWWd2cDItbE5QX2M4andKX3N2R29pdkxTam5aeTM1MF9WV1lHV0NuZGlmUUcwcGZkaklqMGZlSzdPamg5S3ptakZLNkE9PQ==) # <-- Put your encrypted App Store Connect Issuer Id here 
          APP_STORE_CONNECT_KEY_IDENTIFIER: Encrypted(Z0FBQUFBQmhMNGZVempSWm8zMkJrOF9XOVRoRnBZQTdBc3J1QmxWbnNJQzFjdWxJN0R0WGN5YUtxVVBNZ09FMW4wYXluWFNIbEFRRUgtRi1ybVR1UWVfYjFvWUZwRlAwUzRIQXVvaWdRdUpiYzhHa05oLXhoamR4YUNsSG5GTkV6Rkc0T1MxbEZaU3Q=) # <-- Put your encrypted App Store Connect Key Identifier here 
          APP_STORE_CONNECT_PRIVATE_KEY: Encrypted(Z0FBQUFBQmhMNDhSbjQ1OFVMZmFlYzFWb2ZHSGpfa2JyVlY5d0ZzLTFSMElZOEpTZjFyU2NxN2FIa3dremo4aWNuNjJTVF9GTGtucWNjYlk2T1ZDQUpKQ2NZZDR5TDZWRndRMW13Vk0yd2lJSEJEZi05elVlOXhQblRtQ2xRZTZyU2lXeWRXVEx0OTBQV3dLXzBlOHpiZkVQZTh3Z1UxU1NSV1BmWnh1QWpSXy1EUUFhcVRfZGlQU0VyR0NxbC1vZGFTZFhxNEpPZkQ3b2tETlZmMGphQnhiNncxbzdETUJEcEVYYU1nVmI2N1VrX0xXZXpZYkFsUmEzdTFZYXJJMGpHUk9XVHFEa2hscGhuSzNYeVM3cFZpZHM5OEVzcW4xSkVyaGdDcGsycnI4ckJtY19ELVBvREI3dnhJOEJ5eWRiazljbkI0V0FKbEQycHA1Q19mLUtONkxRU3NURXJIWFNnPT0=) # <-- Put your encrypted App Store Connect Private Key here 
          CERTIFICATE_PRIVATE_KEY: Encrypted(Z0FBQUFBQmhMNU5KMExWSVEzMFVtZXJQSmNmclBETllvcS0tOERoMmVNdFlXQ19YcnNQRk9lQ2IxQ251emFtMURTN2dBOGgzMGFFWHNGRGV4Z1RIbTNUdnNoWDEyS21BNlRxZXg0a01PaS1ZVVJuVlZMR2d3MXdKTVdDSnphVlVaVU1fRXZNWlZrSmw1RFZ1N0pEQXprTkhuVGZzS2Z6d1g2aFdlYXJRaTNGcGJWeTB1VDR6NFVkN1dqRGVrZ0VSZlc5bjVDUHNYaTZXR0xoS1c4WWFaMzlFZThfQmRtXzhvdnk4TkF5WGpQcDJ2RVVyVW1SWlhhTlNaQXlBeHZ1R0pRS1Y2dDB0Rm5zQWpZTUN1ZGNkN2lraHRndzFEVVpON09Fa0xMSUVvSGozR2d6N3JCeGp5SXM1cVRfNC1TTThhU0NId3BTRFJWeW1MYk1ZZEx6OHo1YU90Q3BpRGw1V09zRmxnVEM3RGk5aENMRjVhSWNKazJwNWhqWWpQR2lvTnB0Nm9Rc3ZhUWFneXg2V0tKblFOMm1wQ0VIaDZBSlVkT3VaMmx2eklmZlJOVFFNM1RSQ1RiLWxuZlJRaURoaWtad1NLQUFWRUFSUUduX2QyWHVqYjc1TnN4T0xBTEQ0dEhLbGhORkQ3enphbDdZVXc3TzVILWhwRWRGbEZSSG8xQWRiVzQ0U08zel8xQjZTanBoY0E4WWxmMXBUXzNEN1k5TU05bFlkbDdNZGV5NnNSdlJnVzVwXzZKU2lkTHFnMHdzdmEweTBtZi1BcG0tRkktekxadTliRmNWcW9ZX3ROMkJjQ3lQVm9wREM2bFNGdFNGQndCZlU3NTNaNGdwRWtTM2FUSDEyM0E5am1KeTFaeEl3YnVub2h0dHRlT3o5TUVTSHdwVW95SktZTTZaOVZqdHllc0l4WDJ5M1lmMWxTUHhabnJFdlg1MlZrdzN0Y3hIN05iWktHR0tyVFdaYjd3WE1vSElVM2NMTHlvZ2FPdXNsVUZsNDR6czVucjRvc2dSVHEzWVpOc1JnNWh6WHRtT3VlLXRDUVd5RXlEN2l5UjE1Q1RxTW1iWDBHSUZad2d0SGRUWUpuRVdlX25LYkN5UTk2V3c5c2k2VnYyb3dPTmhSOXVWV0ZQdk1QTkVGS0dQZlkwYWpKQUMtZE5OajVoX0JtcWk5a1RLa3BTZEtkdWQtZW9BNFdoRzk0eDhOWFBhQ3ZoT1doemFodDNpX2JpcHpBZzFOc1JfVnZlZTMyUlU2a09qU25GOUNRVVJtWVE1dnB2YzVENzZ6eFM3c25wa3RyUWF6OGVLbW9SeUo1TlNPU2tYbEZ4OEhpdXluNjVSLUlzcGpsTnF3REp0YXFmVWRXWHVxZVZwV1BjNXcyY003Zy0tUlhoXy13c3VQMW5PN2VyNWZWYnp0NWgxbnlFQ0ZuSHRTRGx0cEV6dEp1bmFqdGdTWXY2c01TTFUwdGk1VHZqOE1BamJsR0dCU1JCcF96aHhMWWJfRG1IRnVWbkt2RG9BeWdITnk4a2I3WVhfZmdaaUVOeXI1Ump3SmVxU3h4bDk4d1RfNkl6UWoyMlNIN1FGVFdUQUp2ejVubzYzV2RCZ3cyTWN6a3NCYjQ1VlM5azZzTzBSaER4YmlZeHVFeTd1VURKZHZudFBNOGVLRjJsVm9KaEdtM0VoMG9JMnExRi1SNk5jeTB2Q2FCa0xBNmtCS3l2cWYzMm9aZ1l1NnZhVDZTMDlXT3djRU1oNnpKcHR3aG9EMXhkQ2VXQ2xVeHBOcHpVd1BQWVhJSkNWa3JhVkl1MFRiYUxXQmxDN3VndGdJODVQU2dZOEVoYVJYOHNHQnlFYWtHNWhPdGlScnJ4VEV1Qy1rNTFWRmdsRzI0bHJzUVJ2MGJMVUwyWU9fQnpYa2J5ejZ3MXpHUHBha1JOLWpvZnN1MGxmbnhrbk5TX0tnRzNBZWJZTENnV1NMY3Zuck9lRTZLbXJMQzl1V0xOdmNNTnFCWXowNkhsT3ZLeWF6TjNMNDVKQWVUQzZlR2dFM3M1amZqX1NlbHVYZjRtQ0dERHdLN3N4YW1CWTFWd2tZM3c1Mnh5Um9LbHZnRUZvazhfZURadGcxRjVPZlRKNUlOVjR5RmN6eUp4bGhDTmpKa1NaNVJQTDUyZ0dQSnJyb2VJNEI1ckVCUGRweHRobDBRWklQN1dGVzkwc0xESUJnQmVIMXBPcjgyS01wOWVnNmVBSmZHUkNYRk0yeUg5NzJVZTBaRnlkS1hDdXM4dk0wcWFkdF9hTk5KcTZGVm9kN3ctVnA3ZmVWdThub2dSc1NpRHlUZ3VSMmQxbDlKMXlGSTRFeEw2Umt2WWFRY3I2dTNtc3czTGFtWDQ1ZVlOc3liMHBqa0Y2X0VYM09qVTN4TzdkUF9DeGpPVzJndXN3WFJxQnVtdTdpcXItWVFEdVd6VkJUM0hWZEp6RVliRHhtdmw0Wm5hVWc5N0g1UFYtMGpRMU5qWFBsQXBaN29vZUZ1VkZsWGRUNVA5SDVPUnJjSkVyVmhXN0FqRkUzUTRnRVIzQ0hWZFRVZzExRE9lNkM4dVZoWFdwdHdhWTQ4QmljWGNSYTlVd0VjYTF3UGY4eGFQWDdWQmhRbEIzM3dydlBpVzhiUjQ0RkVVblI1WWFWUnBoeXV0Y1QxWWp0NS1uS3lmaFVEVUl4S1RaalJPNzJRWHQ0RnBuS1JPQWtobmF5dGx5TnhTc1pRWDAyNnpHamZCUktBMDdRQ0JWNXY4X0ItY1VrWWRjU0t2Vi1uQVNaYURyMl84Slg2ZXZ2eVNLa0NjeHk1U3NjVTVDTTNlT1d6NUx3SExUWTZfbzJ3R1JaYWNBN09uN25raHNFR0FkRXNKV0J3R3BBQnNiUm1nOXhteUVyUXBTRGszOG1QOF9DNy1ILUd6RkVrSVNleDRVS25ZVEM0VkRsRnc9PQ==) # <-- Put your encrypted Certificate Private Key here 
          APP_STORE_APP_ID: 1583770606 # <-- Put the app id number here. This is found in App Store Connect > App > General > App Information
        xcode: latest
      triggering:
        events:
          - push
          # - tag
          - pull_request
        branch_patterns:
          - pattern: 'dev'
            include: true
            source: true
          - pattern: 'main'
            include: true
            source: true
      scripts:
        - name: Set up keychain to be used for codesigning using Codemagic CLI 'keychain' command
          script: |
            keychain initialize
        - name: Fetch signing files
          script: |
            app-store-connect fetch-signing-files $BUNDLE_ID --type IOS_APP_STORE --create
        - name: Use system default keychain
          script: |
            keychain add-certificates
        - name: Set up code signing settings on Xcode project
          script: |
            xcode-project use-profiles
        - name: Increment build number
          script: |
            #!/bin/sh
            set -e
            set -x
            cd $FCI_BUILD_DIR
            # agvtool new-version -all $(($BUILD_NUMBER + 1))
            agvtool new-version -all $(($(app-store-connect get-latest-testflight-build-number "$APP_STORE_APP_ID") + 1))
        - name: Build ipa for distribution
          script: |
            xcode-project build-ipa --workspace "$XCODE_WORKSPACE" --scheme "$XCODE_SCHEME"
      artifacts:
        - build/ios/ipa/*.ipa
        - $HOME/Library/Developer/Xcode/DerivedData/**/Build/**/*.dSYM
      publishing:
        app_store_connect:   # https://docs.codemagic.io/publishing-yaml/distribution              
            api_key: $APP_STORE_CONNECT_PRIVATE_KEY         # Contents of the API key, can also reference environment variable such as $APP_STORE_CONNECT_PRIVATE_KEY
            key_id: $APP_STORE_CONNECT_KEY_IDENTIFIER       # Alphanumeric value that identifies the API key, can also reference environment variable such as $APP_STORE_CONNECT_KEY_IDENTIFIER
            issuer_id: $APP_STORE_CONNECT_ISSUER_ID         # Alphanumeric value that identifies who created the API key, can also reference environment variable such as $APP_STORE_CONNECT_ISSUER_ID
            submit_to_testflight: true                     # Optional boolean, defaults to false. Whether or not to submit the uploaded build to TestFlight beta review. Required for distributing to beta groups. Note: This action is performed during post-processing.
            beta_groups:                                    # Specify the names of beta tester groups that will get access to the build once it has passed beta review. 
                  - public
                  # - group name 2
        email:
            recipients:
              - spapinwar@gmail.com
            notify:
              success: true
              failure: true